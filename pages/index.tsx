import { Box } from '@chakra-ui/react';
import Head from 'next/head';
import { NextPageAuth } from '@/types/AuthPages';
import ky from '@lib/ky';
import { useSession } from 'next-auth/react';
import { useEffect, useState } from 'react';
import { EstadosCuentaResponse, EstadoCuenta } from '@/types/ApiResponses';
import Navbar from '@/components/Navbar';

const Home: NextPageAuth = () => {
  const session = useSession();
  const [estadosCuenta, setEstadosCuenta] = useState([] as EstadoCuenta[]);
  const [loading, setLoading] = useState(false);
  const [fetchError, setFetchError] = useState(false);

  useEffect(() => {
    async function getEstadosCuenta() {
      try {
        setLoading(true);
        const res: EstadosCuentaResponse = await ky
          .get('estadosdecuenta/getestadosdecuenta/ActivoUrbano', {
            headers: {
              Authorization: `Bearer ${session.data?.accessToken}`,
            },
          })
          .json();

        const estadosCuenta = res.data;
        setEstadosCuenta(estadosCuenta);
        setLoading(false);
      } catch (error) {
        setFetchError(true);
        setLoading(false);
      }
    }
    getEstadosCuenta();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  return (
    <>
      <Head>
        <title>Zona Activa | Activo Urbano</title>
        <meta name="description" content="Generated by create next app" />
      </Head>
      <Box
        bg="gray.700"
        width="full"
        height="full"
        display="flex"
        flexDir="column"
      >
        <Navbar />
        <Box
          padding={8}
          color="white"
          display="flex"
          flexGrow={1}
          justifyContent={loading || fetchError ? 'center' : 'flex-start'}
          alignItems={loading || fetchError ? 'center' : 'start'}
        >
          {loading ? (
            <Box>Cargando</Box>
          ) : fetchError ? (
            <Box>Hubo un error</Box>
          ) : (
            <Box>Estados de cuenta: {estadosCuenta.length}</Box>
          )}
        </Box>
      </Box>
    </>
  );
};

Home.auth = true;

export default Home;
